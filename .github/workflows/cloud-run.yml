name: scm-system

on: 
    push:
          branches:
            - master
            - main
           

env:
    PROJECT_ID: ${{ secret.CLOUD_RUN_PROJECT_NAME }}
    REGION: asia-southeast1
    REPO_NAME: scm-system

jobs: 
  build-and-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3


      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with: 
          credential_json: ${{ secret.CLOUD_RUN_SERVICE_ACCOUNT }}


      - name: Authirize Docker push
        run: gcloud auth configure-docker

       - name: Build and tag the docker image
        run: |-
          docker build . --tag gcr.io/$PROJECT_ID/$REPO_NAME:$GITHUB_SHA


       - name: Deploy
        run: |-
          gcloud run deploy $REPO_NAME \
          --region $REGION \
          --image gcr.io/$PROJECT_ID/$REPO_NAME:$GITHUB_SHA \
          --platform "managed" \
          --quiet